version: '3'

services:
    apache:
        image: kunstmaan/spaceport-apache
        links:
            - php
        volumes:
            - .:/app:cached
            - app:/app:rw
        hostname: {{ shuttle.apacheVhost }}
        environment:
            VIRTUAL_HOST: {{ shuttle.apacheVhost }},~^{{ shuttle.name }}\..*\.xip\.io
            VIRTUAL_PORT: 80
            DOCUMENT_ROOT: {{ shuttle.apacheDocumentRoot }}
            HTTPS_METHOD: noredirect
            {%- if shuttle.apacheFallbackDomain %}

            FALLBACK_DOMAIN: {{ shuttle.apacheFallbackDomain ~ '\n' }}
            {%- endif %}

    bg-sync:
        image: cweagans/bg-sync
        volumes:
            - .:/source:rw
            - app:/app:rw
        environment:
            SYNC_DESTINATION: /app
            SYNC_MAX_INOTIFY_WATCHES: 40000
            SYNC_VERBOSE: 1
            SYNC_PREFER: newer
            SYNC_EXTRA_UNISON_PROFILE_OPTS: |
              ignore = Name .DS_Store
              ignore = Name *.tmp
              ignore = Name .unison.*
              ignore = Name .idea
              ignore = Name .git
              ignore = Name node_modules
              ignore = Name web/uploads
              ignore = Name .sass-cache
              ignore = Name var/cache
              ignore = Name app/cache
              ignore = Name vendor
              ignore = Name bin
        privileged: true
    php:
        image: kunstmaan/spaceport-php:{{ shuttle.phpVersion }}
        volumes:
            - .:/app:cached
            - app:/app:rw
            - ~/.ssh/id_rsa:/root/.ssh/id_rsa:ro
            - ~/.composer:/root/.composer
        links:
            {% for database in shuttle.databases %}
            {{- '- mysql_' ~ database.mysqlDatabase }}
            {% endfor %}
            {{- '- elasticsearch' }}
        networks:
            - default
            - isolated_maildev
        environment:
            APP_ENV: docker
            XDEBUG: 'off'
            XDEBUG_HOST: '10.254.254.254'
    {% for database in shuttle.databases %}
    {{- 'mysql_' ~ database.mysqlDatabase }}:
        image: kunstmaan/spaceport-mysql
        volumes:
            - {{ 'mysqldata_' ~ database.mysqlDatabase }}:/var/lib/mysql
            - {{ '~/.spaceport/mysql/' ~ database.mysqlDatabase }}:/docker-entrypoint-initdb.d
        environment:
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: {{ database.mysqlDatabase }}
            MYSQL_USER: {{ database.mysqlUser }}
            MYSQL_PASSWORD: {{ database.mysqlPassword }}
    {% endfor %}
    {{- 'elasticsearch:' }}
        image: kunstmaan/spaceport-elasticsearch:{{ shuttle.elasticsearchVersion }}
        environment:
            ES_JAVA_OPTS: "-Xmx256m -Xms256m"
    node:
        image: kunstmaan/spaceport-npm:node-{{ shuttle.nodeVersion }}-alpine
        volumes:
            - app:/src:rw

volumes:
    {% for database in shuttle.databases %}
    {{- 'mysqldata_' ~ database.mysqlDatabase }}: {}
    {% endfor %}
    {{- 'app' }}: {}

networks:
    isolated_maildev:
        external: true
